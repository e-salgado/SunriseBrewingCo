<!DOCTYPE html>
<html lang="en" ng-app="billingApp">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index,follow">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="./style/checkout.css">
    <title>Billing</title>
    <style>
        body {
            -webkit-animation: opening 1s ease-in-out;
            animation: opening 1s ease-in-out;
            background: -webkit-gradient(linear, left top, left bottom, from(black), to(transparent)), url("../img/hero-img.jpg");
            background: linear-gradient(black, transparent), url("../img/hero-img.jpg");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            color: #fff;
        }
    
        input[type="radio"] {
            -webkit-appearance: none;
            /* For Webkit browsers */
            -moz-appearance: none;
            /* For Mozilla browsers */
            appearance: none;
            /* Standard property */
            background-color: #fff;
            /* Default background color when unchecked */
        }
    
        input[type="radio"]:checked {
            background-color: #E3B23C;
            /* Background color when checked */
            border-color: #E3B23C;
            /* Border color when checked */
        }
    
        .btn-primary {
            background: #E3B23C;
            border: none;
        }
    
        .btn-primary:hover {
            background: #6E675F;
        }
    
        .btn-primary:focus {
            background: #6E675F;
        }
    
        .badge {
            background-color: #E3B23C;
        }
    
        .list-inline li a {
            text-decoration: none;
            color: #E3B23C;
        }
    
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
    
        .form-label.required:after {
            content: " *";
            color: #dc3545;
        }
    
        .validation-summary {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 0.375rem;
            color: #721c24;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
        }
    </style>
</head>


    <body class="bg-body-tertiary">
        <div class="container">
            <main>
            <div class="py-5 text-center">
                <h1 class="h2">Billing form</h1>
            </div>
            <div class="row g-5 cart-box">
                <div class="col-md-5 col-lg-4 order-md-last">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">Your
                            cart</h4>
                        <ul id="billing-cart" class="list-group mb-3"></ul>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping (<span id="billing-shipping-method"></span>)</span>
                            <strong id="billing-shipping">$0.00</strong>
                        </li>
                        <h4 class="d-flex justify-content-between align-items-center mt-3">
                            Total (USD)
                            <strong id="billing-total">$0.00</strong>
                        </h4>
                        
                </div>
					<div class="col-md-7 col-lg-8">
						<h4 class="mb-3">Billing Address</h4>
						<!-- validation summary-->
						<div class="validation-summary" ng-show="billingForm.$submitted && billingForm.$invalid">
							<h5>Please fix the following errors:</h5>
							<ul class="mb-0">
								<li ng-show="billingForm.firstName.$error.required">First name is required</li>
								<li ng-show="billingForm.lastName.$error.required">Last name is required</li>
								<li ng-show="billingForm.email.$error.required">Email is required</li>
								<li ng-show="billingForm.email.$error.email">Please enter a valid email address</li>
								<li ng-show="billingForm.address.$error.required">Address is required</li>
								<li ng-show="billingForm.country.$error.required">Country is required</li>
								<li ng-show="billingForm.state.$error.required">State is required</li>
								<li ng-show="billingForm.zip.$error.required">Zip code is required</li>
								<li ng-show="billingForm.zip.$error.pattern">Zip code must be 5 digits</li>
								<li ng-show="billingForm.paymentMethod.$error.required">Payment method is required</li>
								<li ng-show="billingForm.ccName.$error.required">Name on card is required</li>
								<li ng-show="billingForm.ccNumber.$error.required">Card number is required</li>
								<li ng-show="billingForm.ccExpiration.$error.required">Expiration date is required</li>
								<li ng-show="billingForm.ccCVV.$error.required">CVV is required</li>
							</ul>
						</div>

						<form name="billingForm" ng-controller="CheckoutCtrl as vm" novalidate ng-submit="vm.submitForm(billingForm)">
						<div class="row g-3">
						<!-- First Name -->
						<div class="col-sm-6">
							<label for="firstName" class="form-label required">First name</label>
							<input type="text" class="form-control" id="firstName" name="firstName" required ng-model="vm.firstName" minlength="2" maxlength="50">
							<div class="error-message" ng-show="billingForm.firstName.$touched && billingForm.firstName.$error.required">First name is required</div>
							<div class="error-message" ng-show="billingForm.firstName.$touched && billingForm.firstName.$error.minlength">Must be at least 2 characters</div>
						</div>						<!-- Last Name -->
						<div class="col-sm-6">
							<label for="lastName" class="form-label required">Last name</label>
							<input type="text" class="form-control" id="lastName" name="lastName" required ng-model="vm.lastName" minlength="2" maxlength="50">
							<div class="error-message" ng-show="billingForm.lastName.$touched && billingForm.lastName.$error.required">Last name is required</div>
							<div class="error-message" ng-show="billingForm.lastName.$touched && billingForm.lastName.$error.minlength">Must be at least 2 characters</div>
						</div>						<!-- Email -->
						<div class="col-12">
							<label for="email" class="form-label required">Email</label>
							<input type="email" class="form-control" id="email" name="email" required ng-model="vm.email">
							<div class="error-message" ng-show="billingForm.email.$touched && billingForm.email.$error.required">Email is required</div>
							<div class="error-message" ng-show="billingForm.email.$touched && billingForm.email.$error.email">Must be a valid email address</div>
						</div>							<!-- Address 1 -->
							<div class="col-12">
								<label for="address" class="form-label required">Address</label>
								<input type="text" class="form-control" id="address" name="address" required ng-model="vm.AddressOne" minlength="5" maxlength="100">
								<div class="error-message" ng-show="billingForm.address.$touched && billingForm.address.$error.required">Address is required</div>
								<div class="error-message" ng-show="billingForm.address.$touched && billingForm.address.$error.minlength">Address must be at least 5 characters</div>
							</div>

							<!-- Address 2 -->
							<div class="col-12">
								<label for="address2" class="form-label">Address 2 <span class="text-body-secondary">(Optional)</span></label>
								<input type="text" class="form-control" id="address2" name="address2" ng-model="vm.AddressTwo">
							</div>

							<!-- Country -->
							<div class="col-md-5">
								<label for="country" class="form-label required">Country</label>
								<select class="form-select" id="country" name="country" required ng-model="vm.country">
									<option value="">Choose...</option>
									<option>United States</option>
								</select>
							</div>

							<!-- State -->
							<div class="col-md-4">
								<label for="state" class="form-label required">State</label>
								<select class="form-select" id="state" name="state" required ng-model="vm.state">
									<option value="">Select a State</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="DC">District of Columbia</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
								</select>
							</div>

						<!-- ZIP -->
						<div class="col-md-3">
							<label for="zip" class="form-label required">Zip</label>
							<input type="text" class="form-control" id="zip" name="zip" required ng-model="vm.zip" ng-pattern="/^[0-9]{5}$/">
							<div class="error-message" ng-show="billingForm.zip.$touched && billingForm.zip.$error.required">Zip code is required</div>
							<div class="error-message" ng-show="billingForm.zip.$touched && billingForm.zip.$error.pattern">Must be exactly 5 digits</div>
						</div>							<!-- Payment Method -->
							<div class="my-3">
								<div class="form-check">
									<input id="credit" type="radio" name="paymentMethod" class="form-check-input" ng-model="vm.paymentMethod" value="Credit card" required>
									<label class="form-check-label" for="credit">Credit card</label>
								</div>
								<div class="form-check">
									<input id="debit" type="radio" name="paymentMethod" class="form-check-input" ng-model="vm.paymentMethod" value="Debit card" required>
									<label class="form-check-label" for="debit">Debit card</label>
								</div>
							</div>

							<!-- Credit Card Info -->
							<div class="row gy-3">
							<div class="col-md-6">
								<label for="cc-name" class="form-label required">Name on card</label>
								<input type="text" class="form-control" id="cc-name" name="ccName" required ng-model="vm.ccName" minlength="3" maxlength="100">
								<div class="error-message" ng-show="billingForm.ccName.$touched && billingForm.ccName.$error.required">Name on card is required</div>
								<div class="error-message" ng-show="billingForm.ccName.$touched && billingForm.ccName.$error.minlength">Must be at least 3 characters</div>
							</div>
							<div class="col-md-6">
								<label for="cc-number" class="form-label required">Credit card number</label>
								<input type="text" class="form-control" id="cc-number" name="ccNumber" required ng-model="vm.ccNumber" ng-pattern="/^\d{13,19}$/">
								<div class="error-message" ng-show="billingForm.ccNumber.$touched && billingForm.ccNumber.$error.required">Card number is required</div>
								<div class="error-message" ng-show="billingForm.ccNumber.$touched && billingForm.ccNumber.$error.pattern">Must be 13-19 digits</div>
							</div>
							<div class="col-md-3">
								<label for="cc-expiration" class="form-label required">Expiration</label>
								<input type="text" class="form-control" id="cc-expiration" name="ccExpiration" required ng-model="vm.ccExpiration"  ng-pattern="/^(0[1-9]|1[0-2])\/(\d{2})$/">
								<div class="error-message" ng-show="billingForm.ccExpiration.$touched && billingForm.ccExpiration.$error.required">Expiration is required</div>
								<div class="error-message" ng-show="billingForm.ccExpiration.$touched && billingForm.ccExpiration.$error.pattern">Must be in MM/YY format</div>
							</div>
							<div class="col-md-3">
								<label for="cc-cvv" class="form-label required">CVV</label>
								<input type="text" class="form-control" id="cc-cvv" name="ccCVV" required ng-model="vm.ccCVV" ng-pattern="/^\d{3,4}$/">
								<div class="error-message" ng-show="billingForm.ccCVV.$touched && billingForm.ccCVV.$error.required">CVV is required</div>
								<div class="error-message" ng-show="billingForm.ccCVV.$touched && billingForm.ccCVV.$error.pattern">Must be 3-4 digits</div>
							</div>
							</div>

							<hr class="my-4">
							<button class="w-100 btn btn-primary btn-lg orderBtn" type="submit" onclick="placeOrder()">Place Order</button>
						</div>
					</form>
				</div>
                </div>
            </main>
        <footer class="my-5 pt-5 text-body-secondary text-center text-small">
            <p class="mb-3" style="color: #fff;">&copy; 2025 Sunrise Brewing Co</p>
            <ul class="list-inline">
                <li class="list-inline-item"><a href="#">Privacy</a></li>
                <li class="list-inline-item"><a href="#">Terms</a></li>
                <li class="list-inline-item"><a href="#">Support</a></li>
            </ul>
        </footer>
        </div>
<script>
			angular.module('billingApp', [])
			.controller('CheckoutCtrl', function() {
				var vm = this;

				vm.firstName = '';
				vm.lastName = '';
				vm.email = '';
				vm.AddressOne = '';
				vm.AddressTwo = '';
				vm.country = '';
				vm.state = '';
				vm.zip = '';
				vm.paymentMethod = '';
				vm.ccName = '';
				vm.ccNumber = '';
				vm.ccExpiration = '';
				vm.ccCVV = '';

				// Validation functions
				vm.validateField = function(fieldName, value) {
					switch(fieldName) {
						case 'firstName':
						case 'lastName':
							return value && value.trim().length >= 2;
						case 'email':
							return /^[^\s@]+@[^\s@]+\.[a-z]{2,6}$/i.test(value);
						case 'zip':
							return /^[0-9]{5}$/.test(value);
						case 'ccName':
							return value && value.trim().length >= 3;
						case 'ccNumber':
							return /^\d{13,19}$/.test(value.replace(/\s/g, ''));
						case 'ccExpiration':
							return /^(0[1-9]|1[0-2])\/\d{2}$/.test(value);
						case 'ccCVV':
							return /^\d{3,4}$/.test(value);
						default:
							return value && value.toString().trim() !== '';
					}
				};

				vm.submitForm = function(form) {
					if (form.$invalid) {
						angular.forEach(form.$error, function (field) {
							angular.forEach(field, function (errorField) {
								errorField.$setTouched();
							});
						});
						return;
					}

					// Additional client-side validation
					const validationErrors = [];

					if (!vm.validateField('firstName', vm.firstName)) {
						validationErrors.push('First name must be at least 2 characters');
					}
					if (!vm.validateField('lastName', vm.lastName)) {
						validationErrors.push('Last name must be at least 2 characters');
					}
					if (!vm.validateField('email', vm.email)) {
						validationErrors.push('Email must be valid (e.g., user@example.com)');
					}
					if (!vm.validateField('zip', vm.zip)) {
						validationErrors.push('Zip code must be exactly 5 digits');
					}
					if (!vm.validateField('ccName', vm.ccName)) {
						validationErrors.push('Name on card must be at least 3 characters');
					}
					if (!vm.validateField('ccNumber', vm.ccNumber)) {
						validationErrors.push('Card number must be 13-19 digits');
					}
					if (!vm.validateField('ccExpiration', vm.ccExpiration)) {
						validationErrors.push('Expiration must be in MM/YY format');
					}
					if (!vm.validateField('ccCVV', vm.ccCVV)) {
						validationErrors.push('CVV must be 3-4 digits');
					}

					if (validationErrors.length > 0) {
						alert('Validation errors:\n' + validationErrors.join('\n'));
						return;
					}

					const billingData = {
						type: "billing",
						firstName: vm.firstName,
						lastName: vm.lastName,
						email: vm.email,
						address1: vm.AddressOne,
						address2: vm.AddressTwo,
						country: vm.country,
						state: vm.state,
						zip: vm.zip,
						paymentMethod: vm.paymentMethod,
						ccName: vm.ccName,
						ccNumber: vm.ccNumber,
						ccExpiration: vm.ccExpiration,
						ccCVV: vm.ccCVV
					};

					fetch("http://localhost:3000/save-billing", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(billingData)
					})
					.then(res => res.json())
					.then(data => {
						console.log("Saved to CustomerInfo.json:", data);
						alert("Order placed successfully!");
						form.$setPristine();
						form.$setUntouched();
						vm.firstName = vm.lastName = vm.email = vm.AddressOne = vm.AddressTwo = '';
						vm.country = vm.state = vm.zip = vm.paymentMethod = '';
						vm.ccName = vm.ccNumber = vm.ccExpiration = vm.ccCVV = '';
					})
					.catch(err => {
						alert('Error placing order. Please try again.');
						console.error("Error saving data:", err);
					});
					window.location.href = "index.html";
				};
			});

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Read cart from localStorage
        const cart = JSON.parse(localStorage.getItem("cart")) || {};

        const list = document.getElementById("billing-cart");
        const totalEl = document.getElementById("billing-total");
        let shippingData = JSON.parse(localStorage.getItem("selectedShipping")) || {
            method: "USPS",
            price: 0.00
        };

        const SHIPPING_RATE = shippingData.price;


        let html = "";
        let total = 0;

        Object.values(cart).forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            html += `
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">${item.name}</h6>
                        <small class="text-body-secondary">Qty: ${item.quantity}</small>
                    </div>
                    <span class="text-body-secondary">$${itemTotal.toFixed(2)}</span>
                </li>
            `;
        });

        if (Object.keys(cart).length === 0) {
            html = `<li class="list-group-item text-center">Your cart is empty.</li>`;
        }

        list.innerHTML = html;
        document.getElementById("billing-shipping-method").textContent = shippingData.method;
        document.getElementById("billing-shipping").textContent = `$${SHIPPING_RATE.toFixed(2)}`;
        total += SHIPPING_RATE;
        totalEl.textContent  = `$${total.toFixed(2)}`;
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="./script.js"></script>